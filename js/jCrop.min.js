(function(t,e){var c=2,l=11,u=12,d=13,f=21,p=22,g=31,y=32,m=33,v=1,o=2*Math.PI;var i=document.createElement("div"),s="onwheel"in i?"wheel":e.onmousewheel!==undefined?"mousewheel":"DOMMouseScroll";i=null;Function.prototype.prototypeExtend=function(t){if(t.prototype){function e(){}e.prototype=t.prototype;this.prototype=new e;this.prototype.constructor=this;if(Object.defineProperty){Object.defineProperty(this.prototype,"constructor",{enumerable:false})}e=null}};function n(t){return Object.prototype.toString.call(t)==="[object Object]"}function h(t){var e=arguments.length;if(e===0){return Object.create(null)}for(var i=1;i<e;i++){var s=arguments[i];if(!n(s)){continue}var h=Object.keys(s),r=h.length;for(;r--;){var a=h[r];t[a]=s[a]}}return t}function r(t,e){var i=t._opts[e],s=Array.prototype.slice.call(arguments,2);if(i&&typeof i==="function"){i.apply(t,s)}}function _(t,e,i,s){return Math.sqrt(Math.pow(i-t,2)+Math.pow(s-e,2))}function w(t,e,i,s){return Math.atan(s-e/i-t)}function b(t,e,i,s,h,r){if(!!r){t.moveTo(e,i);t.lineTo(e,i+h);t.lineTo(e+s,i+h);t.lineTo(e+s,i)}else{t.rect(e,i,s,h)}t.closePath()}function x(t){var e=t,i=0,s=0;while(e){i+=e.offsetTop;s+=e.offsetLeft;e=e.offsetParent}return{top:i,left:s}}function S(t){var e=document.createElement("canvas"),i=e.getContext("2d");e.width=t.width;e.height=t.height;i.mozImageSmoothingEnabled=false;i.webkitImageSmoothingEnabled=false;i.msImageSmoothingEnabled=false;i.imageSmoothingEnabled=false;i.drawImage(t,0,0);return e}var a=0;function M(t,e){h(this,{maxSize:2e3,quality:1,type:"image/png",width:800,height:600},this._opts=e);this._loadImg(t,this._init);this._uid=++a}M.prototype._loadImg=function(t,i){var s=this,h=t;if(typeof t==="string"){try{h=new Image;h.src=t}catch(t){throw t}}h.setAttribute("crossOrigin","anonymous");h.onload=function(){var t=document.createElement("canvas"),e=t.getContext("2d");try{e.drawImage(this,0,0,0,0);t=e=null;s._img=this;s._imgWidth=this.width;s._imgHeight=this.height;s.isImgLoaded=true;i&&typeof i==="function"&&i.call(s);h=s=null}catch(t){throw t}}};M.prototype._init=function(){this._checkImageSize();this._resetImgSize();this._installViewport();this._initEvent();this.reset();r(this,"created",this.canvas,this.width,this.height)};M.prototype._checkImageSize=function(){var t=this._img,e=this._imgWidth,i=this._imgHeight,s=this.maxSize,h=Math.max(e,i);if(h>s){var r=s/h;t.width=this._imgWidth=e*r;t.height=this._imgHeight=i*r}};M.prototype._resetImgSize=function(){var t=this.width,e=this.height,i=this._imgWidth,s=this._imgHeight,h=Math.max(i/t,s/e);if(h>1){this._imgWidth=i/h;this._imgHeight=s/h}};M.prototype.reset=function(){this.scaleX=1;this.scaleY=1;this.rotateZ=0;this._installCropBox(this.cropType);this._redraw()};M.prototype._installViewport=function(){var t=this.canvas;if(!t){t=this.canvas=e.createElement("canvas");t.innerHTML="浏览器不支持canvas";t.width=this.width;t.height=this.height}};M.prototype._redraw=function(){var t=this.canvas,e=this.width,i=this.height,s=this._imgWidth,h=this._imgHeight,r=this.scaleX,a=this.scaleY,o=this.rotateZ;var n=t.getContext("2d");n.save();n.clearRect(0,0,e,i);n.translate((1-r)*e/2,(1-a)*i/2);n.scale(r,a);n.translate(e/2,i/2);n.rotate(o*Math.PI/180);n.translate(-e/2,-i/2);n.drawImage(this._img,(e-s)/2,(i-h)/2,s,h);n.restore();this._beikCanvas=S(t);this._cropBox&&this._cropBox._redraw()};M.prototype._installCropBox=function(t){var e=this._cropBox;t=String(t).toLowerCase();var i=h(this._opts,{canvas:this.canvas,croperWidth:this.width,croperHeight:this.height,imgWidth:this._imgWidth,imgHeight:this._imgHeight,type:this.type,quality:this.quality,resizable:this.resizable});switch(t){case"circle":e=new W(i);break;default:e=new z(i)}this._cropBox=e;e._parent=this;e.reset()};M.prototype.rotate=function(t){t=parseFloat(t);if(isNaN(t)){return}this.rotateZ=parseFloat(t);this._redraw()};M.prototype.scale=function(t,e){t=parseFloat(t);e=parseFloat(e);if(isNaN(t)||isNaN(e)){return}this.scaleX=Math.min(Math.max(t,.5),3);this.scaleY=Math.min(Math.max(e,.5),3);this._redraw()};M.prototype.on=function(t,e,i){var s=this.canvas,h=this._cacheEvents||[];if(!s){return}h.push({type:t,handle:e,isBobble:!!i});s.addEventListener(t,e,!!i);this._cacheEvents=h};M.prototype.off=function(t,e,i){var s=this.canvas;if(!s){return}var h=this._cacheEvents||[],r=h.length;while(r--){var a=h[r],o=a.type,n=a.handle,c=a.isBobble;if(o==t&&n==e&&c==i||!arguments.length){s.removeEventListener(o,n,c)}}!arguments.length&&(h=[])};M.prototype._initEvent=function(){var t=this.canvas;this.off();this.on("mousedown",this._beginDrag.bind(this));this.on("mousemove",this._dragging.bind(this));this.on("mouseup",this._endDrag.bind(this));this.on(s,this._scroll.bind(this));this.on("touchstart",this._touchStart.bind(this),false);this.on("touchmove",this._touchMove.bind(this),false);this.on("touchend",this._touchEnd.bind(this),false)};M.prototype._beginDrag=function(t){var e=this._cropBox;r(this,"beforeDrag");e.beforeDrag&&e.beforeDrag.call(e,t.offsetX,t.offsetY)};M.prototype._dragging=function(t){var e=this._cropBox;r(this,"dragging");e.dragging&&e.dragging.call(e,t.offsetX,t.offsetY)};M.prototype._endDrag=function(t){var e=this._cropBox;r(this,"endDrag");e.endDrag&&e.endDrag.call(e,t.offsetX,t.offsetY)};M.prototype._touchStart=function(t){t.preventDefault();var e=t.touches,i=e.length;if(i==1){var s=t.changedTouches[0],h=x(this.canvas);this._beginDrag({offsetX:s.clientX-h.left,offsetY:s.clientY-h.top});s=h=null}else if(i==2){this._startTouches=e}};M.prototype._touchMove=function(t){t.preventDefault();var e=t.touches,i=e.length;if(i==1){var s=t.changedTouches[0],h=x(this.canvas);this._dragging({offsetX:s.clientX-h.left,offsetY:s.clientY-h.top});s=h=null}else if(i==2){var r=this._startTouches,a=_(r[0].clientX,r[0].clientY,r[1].clientX,r[1].clientY)/_(e[0].clientX,e[0].clientY,e[1].clientX,e[1].clientY),o=w(r[0].clientX,r[0].clientY,r[1].clientX,r[1].clientY)-w(e[0].clientX,e[0].clientY,e[1].clientX,e[1].clientY);if(a>1){this.scaleX=Math.min(3,this.scaleX+.1);this.scaleY=Math.min(3,this.scaleY+.1)}else if(a<1){this.scaleX=Math.max(.5,this.scaleX+.1);this.scaleY=Math.max(.5,this.scaleY+.1)}this.rotateZ+=o*180/Math.PI;this._redraw()}};M.prototype._touchEnd=function(t){t.preventDefault();var e=t.touches,i=e.length;if(i==1){var s=t.changedTouches[0],h=x(this.canvas);this._endDrag({offsetX:s.clientX-h.left,offsetY:s.clientY-h.top});s=h=null}else if(i==2){this._startTouches=null}};M.prototype._scroll=function(t){var e=t.wheelDelta?t.wheelDelta/-120:t.deltaY?t.deltaY/3:t.detail/3;if(e===-1){this.scale(this.scaleX-.1,this.scaleY-.1)}else if(e===1){this.scale(this.scaleX+.1,this.scaleY+.1)}};M.prototype.cut=function(){return this._cropBox.cut()};M.prototype.destroy=function(){this._cropBox&&this._cropBox.destroy();this._cropBox=null;this.off();var t=this.el;t&&t.removeChild(this.canvas);this._cacheEvents=null;this.canvas=null};function z(t){h(this,{shadowStyle:"rgba(0,0,0,0.4)",lineStyle:"#39f",resizable:false,dashLineStyle:"rgba(254,254,254,0.3)",resizeDotStyle:"#39f",dotSize:5},t)}z.prototype.reset=function(){var t=this.imgWidth,e=this.imgHeight,i=this.croperWidth,s=this.croperHeight,h=Math.min(t,e),r=this.cropWidth,a=this.cropHeight;this.width=r=Math.min(r?r:h/2,t);this.height=a=Math.min(a?a:h/2,e);this.x=(i-r)/2;this.y=(s-a)/2};z.prototype._redraw=function(){var t=this.croperWidth,e=this.croperHeight,i=this.width,s=this.height,h=this.x,r=this.y;this.x=h=Math.min(Math.max(h,0),t-i-1);this.y=r=Math.min(Math.max(r,0),e-s-1);this.drawShadow(h,r);this.drawContent(h,r);this._updateProperty()};z.prototype.drawShadow=function(t,e){var i=this.canvas,s=i.getContext("2d"),h=this.width,r=this.height,a=this.croperWidth,o=this.croperHeight;s.save();s.fillStyle=this.shadowStyle;s.beginPath();b(s,0,0,a,o);b(s,t,e,h,r,true);s.closePath();s.fill();s.restore()};z.prototype.drawContent=function(t,e){var i=this.canvas,s=i.getContext("2d"),h=this.width,r=this.height,a=this.lineStyle;Y(s,t,e,h,r,a,this.dashLineStyle);this.resizable&&k(s,t,e,h,r,Math.max(this.dotSize,1),this.resizeDotStyle)};function Y(t,e,i,s,h,r,a){t.save();t.beginPath();t.lineWidth=1;t.strokeStyle=r;t.rect(X(e),X(i),s,h);t.stroke();t.restore();E(t,X(e+s/3),X(i),X(e+s/3),X(i+h),a);E(t,X(e+s/3*2),X(i),X(e+s/3*2),X(i+h),a);E(t,X(e),X(i+h/3),X(e+s),X(i+h/3),a);E(t,X(e),X(i+h/3*2),X(e+s),X(i+h/3*2),a)}function E(t,e,i,s,h,r,a){a=a||3;var o=_(e,i,s,h),n=Math.floor(o/a);t.save();t.beginPath();t.strokeStyle=r;for(var c=0;c<n;c++){var l=e+(s-e)/n*c,u=i+(h-i)/n*c;t[c&1?"lineTo":"moveTo"](l,u)}t.stroke();t.restore()}function X(t){return parseInt(t)+.5}function k(t,e,i,s,h,r,a){r=r||5;t.save();t.fillStyle=a;I(t,e,i,r);I(t,e+s/2,i,r);I(t,e+s,i,r);I(t,e,i+h/2,r);I(t,e+s,i+h/2,r);I(t,e,i+h,r);I(t,e+s/2,i+h,r);I(t,e+s,i+h,r);t.restore()}function I(t,e,i,s){t.beginPath();t.rect(e-s/2,i-s/2,s,s);t.fill()}z.prototype._updateProperty=function(){var t=this._parent,e=this;h(t,{x:e.x,y:e.y,cropWidth:e.width,cropHeight:e.height})};z.prototype.beforeDrag=function(t,e){this._distanceX=t-this.x;this._distanceY=e-this.y;this._hoverStatus=this.mouseWheelPositioning(t,e)};z.prototype.dragging=function(t,e){var i=this.canvas,s=this.x,h=this.y,r=this.width,a=this.height,o=this._hoverStatus;this.mouseWheelPositioning(t,e);if(!o||o==v){return}switch(o){case l:this.width=r-(t-s);this.height=a-(e-h);this.x=t;this.y=e;break;case u:this.width=r-(t-s);this.x=t;this.y=h;break;case d:this.width=r-(t-s);this.height=a+(e-h-a);this.x=t;this.y=h;break;case f:this.height=a-(e-h);this.x=s;this.y=e;break;case p:this.height=a+(e-h-a);this.x=s;this.y=h;break;case g:this.width=r+(t-s-r);this.height=a+(h-e);this.x=s;this.y=e;break;case y:this.width=r+(t-s-r);this.x=s;this.y=h;break;case m:this.width=r+(t-s-r);this.height=a+(e-h-a);this.x=s;this.y=h;break;default:this.x=t-this._distanceX;this.y=e-this._distanceY}this._parent._redraw()};z.prototype.endDrag=function(t,e){this._hoverStatus=null;this.mouseWheelPositioning(t,e);try{delete this._distanceX;delete this._distanceY;delete this._hoverStatus}catch(t){throw t}};z.prototype.mouseWheelPositioning=function(t,e){var i=this.canvas,s=this.x,h=this.y,r=this.width,a=this.height,o=this.resizable,n=this.dotSize;if(!o){if(t<s||t>s+r||e<h||e>h+a){i.style.cursor="default";return v}else{i.style.cursor="move";return c}}s-=n/2;h-=n/2;if(t<s||t>s+r+n||e<h||e>h+a+n){i.style.cursor="default";return v}else if(t<s+n){if(e<h+n){i.style.cursor="nw-resize";return l}if(e<h+a-n){i.style.cursor="w-resize";return u}i.style.cursor="sw-resize";return d}else if(t>=s+n&&t<=s+r-n){if(e<h+n){i.style.cursor="n-resize";return f}if(e<=h+a-n){i.style.cursor="move";return c}i.style.cursor="s-resize";return p}else if(t>s+r-n){if(e<h+n){i.style.cursor="ne-resize";return g}if(e<=h+a-n){i.style.cursor="e-resize";return y}i.style.cursor="se-resize";return m}};z.prototype.cut=function(){var t=this.x,e=this.y,i=this.width,s=this.height,h=this._parent._beikCanvas,r=document.createElement("canvas"),a=r.getContext("2d");r.width=i;r.height=s;a.mozImageSmoothingEnabled=false;a.webkitImageSmoothingEnabled=false;a.msImageSmoothingEnabled=false;a.imageSmoothingEnabled=false;a.clearRect(0,0,i,s);a.drawImage(h,t,e,i,s,0,0,i,s);return r.toDataURL(this.type,this.quality)};z.prototype.destroy=function(){this.canvas=this._parent=null};function W(t){z.call(this,t)}W.prototypeExtend(z);W.prototype.reset=function(){var t=this.croperWidth,e=this.croperHeight,i=this.imgWidth,s=this.imgHeight,h=Math.min(i,s),r=this.radius,a=this.x,o=this.y;this.radius=r=Math.min(r?r:h/4,h/2);this.x=a===undefined?(t-2*r)/2:a;this.y=o===undefined?(e-2*r)/2:o};W.prototype._redraw=function(){var t=this.croperWidth,e=this.croperHeight,i=this.radius,s=this.x,h=this.y;this.x=s=Math.min(Math.max(s,0),t-2*i);this.y=h=Math.min(Math.max(h,0),e-2*i);this.drawShadow(s,h);this.drawContent(s,h);this._updateProperty()};W.prototype._updateProperty=function(){var t=this._parent,e=this;h(t,{x:e.x,y:e.y,radius:e.radius})};W.prototype.drawShadow=function(t,e){var i=this.canvas,s=i.getContext("2d"),h=this.radius,r=this.croperWidth,a=this.croperHeight;s.fillStyle="rgba(0,0,0,0.4)";s.beginPath();s.rect(0,0,r,a);s.arc(t+h,e+h,h,0,o,true);s.fill()};W.prototype.drawContent=function(t,e){var i=this.canvas,s=i.getContext("2d"),h=this.radius,r=this.lineStyle;D(s,t,e,h,r,this.dashLineStyle);this.resizable&&P(s,t,e,h,Math.max(this.dotSize,1),this.resizeDotStyle)};function D(t,e,i,s,h,r){t.beginPath();t.strokeStyle=h;t.arc(e+s,i+s,s,0,o);t.stroke();E(t,X(e+s),X(i),X(e+s),X(i+s*2),r);E(t,X(e),X(i+s),X(e+s*2),X(i+s),r)}function P(t,e,i,s,h,r){t.fillStyle=r;h=h||5;I(t,e+s,i,h);I(t,e+2*s,i+s,h);I(t,e+s,i+2*s,h);I(t,e,i+s,h)}W.prototype.mouseWheelPositioning=function(t,e){var i=this.canvas,s=this.x,h=this.y,r=this.radius,a=this.resizable,o=this.dotSize;if(a){if(t>=s-o/2&&t<=s+o/2&&e>=h+r-o/2&&e<=h+r+o/2){i.style.cursor="w-resize";return u}if(t>=s+r-o/2&&t<=s+r+o/2&&e>=h-o/2&&e<=h+o/2){i.style.cursor="n-resize";return f}if(t>=s+r-o/2&&t<=s+r+o/2&&e>=h+2*r-o/2&&e<=h+2*r+o/2){i.style.cursor="s-resize";return p}if(t>=s+2*r-o/2&&t<=s+2*r+o/2&&e>=h+r-o/2&&e<=h+r+o/2){i.style.cursor="e-resize";return y}}s+=r;h+=r;if(_(s,h,t,e)>r){i.style.cursor="default";return v}else{i.style.cursor="move";return c}};W.prototype.dragging=function(t,e){var i=this.canvas,s=this.x,h=this.y,r=this.radius,a=this._hoverStatus,o=2*r;this.mouseWheelPositioning(t,e);if(!a||a==v){return}switch(a){case u:this.radius=r-(t-s)/2;this.x=t;this.y=h+(t-s)/2;break;case f:this.radius=r-(e-h)/2;this.x=s+(e-h)/2;this.y=e;break;case p:this.radius=r+(e-h-o)/2;this.x=s-(e-h-o)/2;this.y=h;break;case y:this.radius=r+(t-s-o)/2;this.x=s;this.y=h-(t-s-o)/2;break;default:this.x=t-this._distanceX;this.y=e-this._distanceY}this._parent._redraw()};W.prototype.cut=function(){var t=this.x,e=this.y,i=this.radius,s=2*i,h=this._parent._beikCanvas,r=document.createElement("canvas"),a=r.getContext("2d");r.width=s;r.height=s;a.mozImageSmoothingEnabled=false;a.webkitImageSmoothingEnabled=false;a.msImageSmoothingEnabled=false;a.imageSmoothingEnabled=false;a.clearRect(0,0,s,s);a.arc(i,i,i,0,o);a.clip();a.drawImage(h,t,e,s,s,0,0,s,s);return r.toDataURL("image/png",this.quality)};function C(t,e){return new M(t,e)}t.jCrop=C})(window,document);