(function(t,o){var i=document.createElement("div"),e="onwheel"in i?"wheel":o.onmousewheel!==undefined?"mousewheel":"DOMMouseScroll";i=null;function n(t){return Object.prototype.toString.call(t)==="[object Object]"}function h(t){var i=arguments.length;if(i===0){return Object.create(null)}for(var e=1;e<i;e++){var h=arguments[e];if(!n(h)){continue}var s=Object.keys(h),o=s.length;for(;o--;){var r=s[o];t[r]=h[r]}}return t}function a(t,i){var e=t[i],h=Array.prototype.slice.call(arguments,2);if(e&&typeof e==="function"){e.apply(t,h)}}function d(t,i,e,h){return Math.sqrt(Math.pow(e-t,2)+Math.pow(h-i,2))}function r(t,i,e,h,s,o){i=f(i);e=f(e);h=Math.floor(h);s=Math.floor(s);if(!!o){t.moveTo(i,e);t.lineTo(i,e+s);t.lineTo(i+h,e+s);t.lineTo(i+h,e)}else{t.rect(i,e,h,s)}}function c(t,i,e){t.lineTo(f(i),f(e))}function g(t,i,e){t.moveTo(f(i),f(e))}function f(t){return parseInt(t)+.5}function l(t,i,e,h,s,o,r){i=f(i);e=f(e);h=f(h);s=f(s);r=r||5;var n=d(i,e,h,s),a=Math.floor(n/r);t.save();t.beginPath();t.strokeStyle=o;for(var c=0;c<a;c++){var g=i+(h-i)/a*c,l=e+(s-e)/a*c;t[c&1?"lineTo":"moveTo"](g,l)}t.stroke();t.restore()}function p(t){var i=t,e=0,h=0;while(i){e+=i.offsetTop;h+=i.offsetLeft;i=i.offsetParent}return{top:e,left:h}}var s=0;function u(t,i){if(!t){throw new Error("The img source must be required")}h(this,{maxSize:2e3,croperWidth:800,croperHeight:600,width:300,height:300,shadowColor:"rgba(0,0,0,0.7)",lineColor:"#fff",dashLineColor:"rgba(255,255,255,0.8)",edgeWidth:3,quality:1,offBackgroundColor:"rgba(0,0,0,0.6)",onBackgroundColor:"rgba(0,0,0,0.2)",imgType:"image/png",scalable:true,scaleStep:this.scaleStep,_zoom:2},this._opts=i);this._loadImg(t,this._init);this._uid=++s}u.prototype._loadImg=function(t,i){var e=this,h=t;if(typeof t==="string"){try{h=new Image;h.src=t}catch(t){throw t}}h.setAttribute("crossOrigin","anonymous");h.onload=function(){e._img=this;e._originWidth=this.width;e._originHeight=this.height;e.isImgLoaded=true;i&&typeof i==="function"&&i.call(e);h=e=null}};u.prototype._init=function(){this._limitImageSize();this._initData();this._createImageSource();this._initCanvas();this._initEvent();this.reset();a(this,"created",this.canvas,this.croperWidth,this.croperHeight,this.width,this.height)};u.prototype._limitImageSize=function(){var t=this._img,i=this._originWidth,e=this._originHeight,h=this.maxSize,s=Math.max(i,e);if(s>h){var o=h/s;this._originWidth=i*o;this._originHeight=e*o}};u.prototype._initData=function(){var t=this.width,i=this.height,e=this.croperWidth,h=this.croperHeight,s=this._originWidth,o=this._originHeight;t=this.width=Math.min(t,e);i=this.height=Math.min(i,h);var r=Math.max(s/e,o/h),n=Math.min(s/t,o/i);if(r>1){s=this._originWidth=s/r;o=this._originHeight=o/r}this._minScale=Math.max(t/s,i/o);if(n<1){this._originWidth=s/n;this._originHeight=o/n;this._minScale=1}};u.prototype._createImageSource=function(){var t=o.createElement("canvas"),i=t.getContext("2d"),e=this._originWidth,h=this._originHeight,s=this._zoom;t.width=e*s;t.height=h*s;t.style.width=e+"px";t.style.height=h+"px";i.mozImageSmoothingEnabled=false;i.webkitImageSmoothingEnabled=false;i.msImageSmoothingEnabled=false;i.imageSmoothingEnabled=false;i.drawImage(this._img,0,0,e*s,h*s);this._imageSource=t};u.prototype._initCanvas=function(){var t=this.canvas;if(t){return}t=this.canvas=o.createElement("canvas");var i=this.croperWidth,e=this.croperHeight,h=this._zoom;t.width=i*h;t.height=e*h;t.style.width=i+"px";t.style.height=e+"px";var s=this.ctx=t.getContext("2d");s.mozImageSmoothingEnabled=false;s.webkitImageSmoothingEnabled=false;s.msImageSmoothingEnabled=false;s.imageSmoothingEnabled=false};u.prototype._initEvent=function(){this.on("mousedown",this._beginDrag.bind(this));this.on("mousemove",this._dragging.bind(this));this.on("mouseup",this._endDrag.bind(this));this.on(e,this._scroll.bind(this));this.on("touchstart",this._touchStart.bind(this),false);this.on("touchmove",this._touchMove.bind(this),false);this.on("touchend",this._touchEnd.bind(this),false)};u.prototype.on=function(t,i,e){var h=this.canvas,s=this._cacheEvents||[];if(!h){return}s.push({type:t,handler:i,isBobble:!!e});h.addEventListener(t,i,!!e);this._cacheEvents=s};u.prototype.off=function(t,i,e){var h=this.canvas,s=this._cacheEvents;if(!h||!s){return}var o=s.length;while(o--){var r=s[o],n=r.type,a=r.handler,c=r.isBooble;if(t===undefined||n===t&&a===i&&c===e){h.removeEventListener(n,a,c);s.splice(o,1)}}};u.prototype._beginDrag=function(t){a(this,"beforeDrag",this.x,this,y);var i=this._zoom;this._isDragging=true;this._distanceX=t.offsetX*i-this.x;this._distanceY=t.offsetY*i-this.y;this._backgroundColor=this.onBackgroundColor;this._redraw()};u.prototype._dragging=function(t){a(this,"dragging",this.x,this,s);if(!this._isDragging){return}var i=this.x,e=this.y,h=t.offsetX,s=t.offsetY,o=this.croperWidth*.01,r=this.croperHeight*.01;if(h<o||h>this.croperWidth*.99||s<r||s>this.croperHeight*.99){this._endDrag();return}var n=this._zoom;this.x=h*n-this._distanceX;this.y=s*n-this._distanceY;this._redraw()};u.prototype._endDrag=function(){a(this,"dragged",this.x,this,y);this._isDragging=false;this._backgroundColor=this.offBackgroundColor;this._distanceX=this._distanceY=null;this._redraw()};u.prototype._scroll=function(t){t.preventDefault();if(!this.scalable){return}var i=t.wheelDelta?t.wheelDelta/-120:t.deltaY?t.deltaY/3:t.detail/3,e=this.scale,h=parseFloat(this.scaleStep);if(i===-1){this.scaling(e-h)}else if(i===1){this.scaling(e+h)}};u.prototype._touchStart=function(t){t.preventDefault();var i=t.touches,e=i.length;if(e==1){var h=t.changedTouches[0],s=p(this.canvas);this._beginDrag({offsetX:h.clientX-s.left,offsetY:h.clientY-s.top});h=s=null}else if(e==2){this._startTouches=i}};u.prototype._touchMove=function(t){t.preventDefault();var i=t.touches,e=i.length;if(e==1){var h=t.changedTouches[0],s=p(this.canvas);this._dragging({offsetX:h.clientX-s.left,offsetY:h.clientY-s.top});h=s=null}else if(e==2){var o=this._startTouches,r=d(i[0].clientX,i[0].clientY,i[1].clientX,i[1].clientY)/d(o[0].clientX,o[0].clientY,o[1].clientX,o[1].clientY),n=parseFloat(this.scaleStep);if(r>1){this.scaling(this.scale+n)}else if(r<1){this.scaling(this.scale-n)}}};u.prototype._touchEnd=function(t){t.preventDefault();var i=t.changedTouches,e=i.length;if(e==1){var h=i[0],s=p(this.canvas);this._endDrag({offsetX:h.clientX-s.left,offsetY:h.clientY-s.top});h=s=null}else if(e==2){this._startTouches=null}};u.prototype.scaling=function(t){a(this,"beforeScale",this.scale);t=parseFloat(t);if(isNaN(t)){return}this.scale=Math.max(t,this._minScale);this._redraw();a(this,"scaled",this.scale)};u.prototype.reset=function(t,i,e){a(this,"beforeReset",this.x,this.y,this.scale);var h=this._originWidth,s=this._originHeight,o=this.croperWidth,r=this.croperHeight,t=parseFloat(t),i=parseFloat(i),e=parseFloat(e),n=this._zoom;this.x=(isNaN(t)?(o-h)/2:t)*n;this.y=(isNaN(i)?(r-s)/2:i)*n;this.scale=Math.max(isNaN(e)?1:e,this._minScale);this._backgroundColor=this.offBackgroundColor;this._redraw();a(this,"reseted",this.x,this.y,this.scale)};u.prototype._redraw=function(){this._limitPosition();var t=this.ctx,i=this.scale,e=this._zoom,h=this.croperWidth*e,s=this.croperHeight*e,o=this._originWidth*e,r=this._originHeight*e,n=this.width,a=this.height,c=this.x,g=this.y;t.clearRect(0,0,h,s);t.save();t.fillStyle=this.shadowColor;t.fillRect(0,0,h,s);t.drawImage(this._imageSource,c,g,o*i,r*i);t.restore();this._drawCropBox()};u.prototype._limitPosition=function(){var t=this.scale,i=this._zoom,e=this.croperWidth*i,h=this.croperHeight*i,s=this._originWidth*i*t,o=this._originHeight*i*t,r=this.width*i,n=this.height*i,a=(e-r)/2,c=(h-n)/2,g=this.x,l=this.y;this.x=Math.max(Math.min(g,a),e-a-s);this.y=Math.max(Math.min(l,c),h-c-o)};u.prototype._drawCropBox=function(){var t=this.ctx,i=this._zoom,e=this.width*i,h=this.height*i,s=e/10;vDistance=h/10,edgeWidth=this.edgeWidth,lineColor=this.lineColor,croperWidth=this.croperWidth*i,croperHeight=this.croperHeight*i,x=(croperWidth-e)/2,y=(croperHeight-h)/2,edgeX=(croperWidth-e-edgeWidth)/2,edgeY=(croperHeight-h-edgeWidth)/2,cWidth=e+edgeWidth,cHeight=h+edgeWidth;t.save();t.beginPath();t.fillStyle=this._backgroundColor;r(t,0,0,croperWidth,croperHeight,true);r(t,x,y,e,h);t.closePath();t.fill();t.restore();t.save();t.strokeStyle=lineColor;t.beginPath();r(t,x,y,e,h);t.closePath();t.stroke();t.lineWidth=edgeWidth;t.beginPath();g(t,edgeX,edgeY);c(t,edgeX+s,edgeY);g(t,edgeX+cWidth-s,edgeY);c(t,edgeX+cWidth,edgeY);g(t,edgeX+cWidth,edgeY);c(t,edgeX+cWidth,edgeY+vDistance);g(t,edgeX+cWidth,edgeY+cHeight-vDistance);c(t,edgeX+cWidth,edgeY+cHeight);g(t,edgeX+cWidth,edgeY+cHeight);c(t,edgeX+cWidth-s,edgeY+cHeight);g(t,edgeX+s,edgeY+cHeight);c(t,edgeX,edgeY+cHeight);g(t,edgeX,edgeY+cHeight);c(t,edgeX,edgeY+cHeight-vDistance);g(t,edgeX,edgeY);c(t,edgeX,edgeY+vDistance);t.stroke();t.restore();l(t,x,y+h/3,x+e,y+h/3,this.dashLineColor,5);l(t,x,y+h/3*2,x+e,y+h/3*2,this.dashLineColor,5);l(t,x+e/3,y,x+e/3,y+h,this.dashLineColor,5);l(t,x+e/3*2,y,x+e/3*2,y+h,this.dashLineColor,5)};u.prototype.cut=function(){var t=this.scale,i=this._zoom,e=this.croperWidth*i,h=this.croperHeight*i,s=this._originWidth*t,o=this._originHeight*t,r=this.width,n=this.height,a=(e-r*i)/2,c=(h-n*i)/2,g=this.x,l=this.y,d=document.createElement("canvas"),f=d.getContext("2d");d.width=s*i;d.height=o*i;d.style.width=s+"px";d.style.height=o+"px";f.clearRect(0,0,s*i,o*i);g=parseInt(a-g);l=parseInt(c-l);f.rect(g,l,r*i,n*i);f.clip();f.drawImage(this._imageSource,0,0,s*i,o*i);var p=document.createElement("canvas"),u=p.getContext("2d"),_=f.getImageData(g,l,r*i,n*i);d=f=null;p.width=r*i;p.height=n*i;p.style.width=r+"px";p.style.height=n+"px";u.putImageData(_,0,0,0,0,r*i,n*i);return p.toDataURL(this.imgType,this.quality)};u.prototype.destroy=function(){a(this,"beforeDestroy");var t=this.canvas;t.parentNode&&t.parentNode.removeChild(t);this.off();t=this.canvas=this.ctx=this._imageSource=this._opts=this._cacheEvents=null;a(this,"destroyed")};function _(t,i){return new u(t,i)}t.jCrop=_})(window,document);